<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Pilot</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, system-ui, sans-serif;
      background: #111;
      color: #eee;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #status {
      padding: 8px 16px;
      background: #222;
      font-size: 12px;
      color: #888;
      display: flex;
      justify-content: space-between;
    }
    #status.connected { color: #4a4; }
    #status.error { color: #a44; }
    #output {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .msg { margin-bottom: 12px; padding: 8px; border-radius: 4px; }
    .msg.user { background: #234; }
    .msg.system { background: #333; }
    .msg.error { background: #422; }
    .latency { color: #666; font-size: 11px; }
    #controls {
      padding: 12px;
      background: #222;
      display: flex;
      gap: 8px;
    }
    #textInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #333;
      color: #fff;
      font-size: 16px;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #446;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    button:active { background: #558; }
    button.recording { background: #a44; }
    #micBtn { font-size: 20px; }
    #authModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #authModal.hidden { display: none; }
    #authForm {
      background: #222;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
    }
    #authForm input {
      margin: 16px 0;
      padding: 12px;
      width: 100%;
      border: 1px solid #444;
      border-radius: 8px;
      background: #333;
      color: #fff;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="status">
    <span id="connStatus">Connecting...</span>
    <span id="latency"></span>
  </div>
  <div id="output"></div>
  <div id="controls">
    <input type="text" id="textInput" placeholder="Type command..." autocomplete="off">
    <button id="micBtn">ðŸŽ¤</button>
    <button id="sendBtn">â†’</button>
  </div>

  <div id="authModal">
    <div id="authForm">
      <h2>Pilot</h2>
      <p>Enter access token</p>
      <input type="password" id="tokenInput" placeholder="Token">
      <button id="authBtn">Connect</button>
    </div>
  </div>

<script>
const output = document.getElementById('output');
const textInput = document.getElementById('textInput');
const micBtn = document.getElementById('micBtn');
const sendBtn = document.getElementById('sendBtn');
const connStatus = document.getElementById('connStatus');
const latencyEl = document.getElementById('latency');
const authModal = document.getElementById('authModal');
const tokenInput = document.getElementById('tokenInput');
const authBtn = document.getElementById('authBtn');

let ws = null;
let token = localStorage.getItem('pilot_token');
let mediaRecorder = null;
let audioChunks = [];
let gps = null;

// Get GPS
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    pos => { gps = { lat: pos.coords.latitude, lon: pos.coords.longitude }; },
    () => {},
    { enableHighAccuracy: false, timeout: 5000 }
  );
}

function log(text, type = 'system') {
  const div = document.createElement('div');
  div.className = `msg ${type}`;
  div.textContent = text;
  output.appendChild(div);
  output.scrollTop = output.scrollHeight;
}

function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws?token=${token}`);

  ws.onopen = () => {
    connStatus.textContent = 'Connected';
    document.getElementById('status').className = 'connected';
    authModal.classList.add('hidden');
  };

  ws.onclose = (e) => {
    connStatus.textContent = 'Disconnected';
    document.getElementById('status').className = 'error';
    if (e.code === 4001) {
      localStorage.removeItem('pilot_token');
      token = null;
      authModal.classList.remove('hidden');
    } else {
      setTimeout(connect, 2000);
    }
  };

  ws.onerror = () => {
    connStatus.textContent = 'Error';
    document.getElementById('status').className = 'error';
  };

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'response') {
      log(data.summary, 'system');
      latencyEl.textContent = `${data.latency_ms}ms`;
    } else if (data.type === 'state') {
      // Could show tmux state preview
    } else if (data.type === 'error') {
      log(`Error: ${data.message}`, 'error');
    }
  };
}

function send(text = null, audio = null) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  const msg = { type: 'cmd' };
  if (text) msg.text = text;
  if (audio) msg.audio = audio;
  if (gps) msg.gps = gps;
  ws.send(JSON.stringify(msg));
  if (text) log(`> ${text}`, 'user');
}

// Text input
sendBtn.onclick = () => {
  const text = textInput.value.trim();
  if (text) {
    send(text);
    textInput.value = '';
  }
};
textInput.onkeydown = (e) => {
  if (e.key === 'Enter') sendBtn.click();
};

// Voice input
micBtn.onclick = async () => {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    micBtn.classList.remove('recording');
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    audioChunks = [];

    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const reader = new FileReader();
      reader.onloadend = () => {
        const b64 = reader.result.split(',')[1];
        send(null, b64);
        log('> [voice]', 'user');
      };
      reader.readAsDataURL(blob);
    };

    mediaRecorder.start();
    micBtn.classList.add('recording');
  } catch (err) {
    log(`Mic error: ${err.message}`, 'error');
  }
};

// Auth
authBtn.onclick = () => {
  token = tokenInput.value.trim();
  if (token) {
    localStorage.setItem('pilot_token', token);
    connect();
  }
};

// Start
if (token) {
  connect();
} else {
  authModal.classList.remove('hidden');
}
</script>
</body>
</html>

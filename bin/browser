#!/usr/bin/env python3
"""
Persistent browser for agent use.
Maintains cookies, localStorage, and login sessions across runs.

Usage:
  browser              # Launch persistent browser (headed if DISPLAY, else headless)
  browser --headed     # Force headed mode (requires DISPLAY or Xvfb)
  browser --headless   # Force headless mode
  browser --cdp        # Print CDP endpoint for remote control
"""

import asyncio
import argparse
import os
import sys

PROFILE_DIR = os.path.expanduser("~/.browser-profile")

async def main():
    parser = argparse.ArgumentParser(description="Persistent browser for agents")
    parser.add_argument("--headed", action="store_true", help="Force headed mode")
    parser.add_argument("--headless", action="store_true", help="Force headless mode")
    parser.add_argument("--cdp", action="store_true", help="Print CDP endpoint and wait")
    args = parser.parse_args()

    from playwright.async_api import async_playwright

    async with async_playwright() as p:
        # Determine headless mode
        if args.headless:
            headless = True
        elif args.headed:
            headless = False
        else:
            # Auto-detect: headless if no DISPLAY
            headless = not os.environ.get("DISPLAY")

        print(f"Launching browser (headless={headless}, profile={PROFILE_DIR})")

        # Launch persistent context - this saves cookies, localStorage, etc.
        context = await p.chromium.launch_persistent_context(
            user_data_dir=PROFILE_DIR,
            headless=headless,
            viewport={"width": 1920, "height": 1080},
            # Make it look like a real browser
            args=[
                "--disable-blink-features=AutomationControlled",
                "--no-sandbox",
            ],
            ignore_default_args=["--enable-automation"],
            # Accept downloads
            accept_downloads=True,
            downloads_path=os.path.expanduser("~/Downloads"),
        )

        page = context.pages[0] if context.pages else await context.new_page()

        if args.cdp:
            # For remote control via CDP
            # Note: persistent context doesn't expose CDP directly,
            # you'd need to use browser.new_context() for that
            print("CDP mode not supported with persistent context")
            print("Use browser-use or playwright codegen for interaction")

        print(f"Browser ready. Pages: {len(context.pages)}")
        print("Press Ctrl+C to close")

        # Keep running until interrupted
        try:
            while True:
                await asyncio.sleep(1)
        except KeyboardInterrupt:
            print("\nClosing browser...")

        await context.close()

if __name__ == "__main__":
    asyncio.run(main())
